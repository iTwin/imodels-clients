name:
  $(Date:yyyy.M.d)$(Rev:.r)

trigger: none

pool:
  name: iModelTechCI
  demands: Agent.OS -equals Windows_NT

jobs:
  - job: BuildAndTestDev
    variables:
      - group: iModels Clients - Integration Tests - DEV

    steps:
    - task: NodeTool@0
      displayName: Install Node@14.17.5
      inputs:
        versionSpec: '14.17.5'
        checkLatest: true
        
    - script: node common/scripts/install-run-rush.js install --purge
      displayName: rush install
    
    - script: node common/scripts/install-run-rush.js rebuild -v
      displayName: rush rebuild
    
    - script: node common/scripts/install-run-rush.js lint
      displayName: rush lint
    
    - script: node common/scripts/install-run-rush.js spell-check
      displayName: rush spell-check
      
    - script: node common/scripts/install-run-rush.js publish --pack --include-all --publish
      displayName: rush publish (into .tgz)
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    
    - script: node common/scripts/install-run-rush.js test:integration
      displayName: rush test integration
      env:
        AUTH_CLIENT_ID: $(AUTH_CLIENT_ID)
        AUTH_CLIENT_SECRET: $(AUTH_CLIENT_SECRET)
        TEST_USER_EMAIL: $(TEST_USER_EMAIL)
        TEST_USER_PASSWORD: $(TEST_USER_PASSWORD)